{% extends "core/base.html" %}
{% block content %}

<!-- Button to open overlay -->
<div class="container mx-auto px-4 py-6">
  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    
    <!-- Left Sidebar (Filters) -->
    <aside class="col-span-1 bg-white p-4 rounded-lg shadow">
      <h2 class="text-lg font-semibold mb-4">Refine Your Search</h2>
      <form id="filter-form">
        <input type="hidden" name="q" value="{{ query }}">

        <!-- Year -->
        <div class="mb-3">
          <label class="block text-sm font-medium">Year</label>
          <select name="year" class="w-full border p-2 rounded filter-input">
            <option value="">Select Year</option>
            {% for y in years %}
              <option value="{{ y }}" {% if request.GET.year == y|stringformat:"s" %}selected{% endif %}>{{ y }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Make -->
        <div class="mb-3">
          <label class="block text-sm font-medium">Make</label>
          <select name="make" id="make" class="w-full border p-2 rounded filter-input">
            <option value="">Select Make</option>
            {% for m in makes %}
              <option value="{{ m }}" {% if request.GET.make == m %}selected{% endif %}>{{ m }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Model -->
        <div class="mb-3">
          <label class="block text-sm font-medium">Model</label>
          <select name="model" id="model" class="w-full border p-2 rounded filter-input">
            <option value="">Select Model</option>
            {% if models %}
            {% for mdl in models %}
              <option value="{{ mdl }}" {% if request.GET.model == mdl %}selected{% endif %}>{{ mdl }}</option>
            {% endfor %}
            {% endif %}
          </select>
        </div>

        <!-- Submodel -->
        <div class="mb-3">
          <label class="block text-sm font-medium">Submodel</label>
          <select name="submodel" id="submodel" class="w-full border p-2 rounded filter-input">
            <option value="">Select Submodel</option>
            {% if sub_models %}
            {% for sm in sub_models %}
              <option value="{{ sm }}" {% if request.GET.sub_model == sm %}selected{% endif %}>{{ sm }}</option>
            {% endfor %}
            {% endif %}
          </select>
        </div>
      </form>
    </aside>

    <!-- Right Side (Search Results) -->
    <main class="col-span-3">
      <h2 class="text-xl font-semibold mb-4">
        We found {{ ads.count }} results for "{{ query }}"
      </h2>

      <div id="results-container">
        {% include "core/search_results_list.html" %}
      </div>
    </main>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const filterForm = document.getElementById("filter-form");
    const inputs = filterForm.querySelectorAll(".filter-input");

    inputs.forEach(input => {
        input.addEventListener("change", function() {
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData).toString();

            fetch(`?${params}`, {
                headers: { "x-requested-with": "XMLHttpRequest" }
            })
            .then(res => res.text())
            .then(html => {
                document.getElementById("results-container").innerHTML = html;
            });
        });
    });
});

// Dependent dropdown: Make → Model
document.getElementById("make").addEventListener("change", function() {
    fetch(`/get-models/?make=${this.value}`)
        .then(res => res.json())
        .then(data => {
            let modelSelect = document.getElementById("model");
            modelSelect.innerHTML = '<option value="">Select Model</option>';
            data.models.forEach(m => {
                modelSelect.innerHTML += `<option value="${m}">${m}</option>`;
            });
            document.getElementById("submodel").innerHTML = '<option value="">Select Submodel</option>';
        });
});

    // Dependent dropdown: Model → Submodel
document.getElementById("model").addEventListener("change", function() {
    fetch(`/get-submodels/?model=${this.value}`)
        .then(res => res.json())
        .then(data => {
            let sub_modelSelect = document.getElementById("submodel");
            sub_modelSelect.innerHTML = '<option value="">Select Submodel</option>';
            data.sub_models.forEach(sm => {
                sub_modelSelect.innerHTML += `<option value="${sm}">${sm}</option>`;
            });
        });
});
</script>

{% endblock %}